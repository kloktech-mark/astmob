#summary Installation instructions.
#labels Phase-Deploy

AST is written in Ruby on Rails(RoR) and it has a notion of dev and production environment where one can have different settings for each.  Very useful as it gives a way to play with new thing without breaking production while still having code check in.

Therefore, we will break installation into two sections, one for dev and one for production.  However, it is NOT mandatory to use production method to run in production, it's just a bit more optimized in things like caching.

Some of the initial setup such as DB setup are the same between dev and production.

= Prerequisite =

System requirements:
 * ruby 1.8+
 * ruby-dev
 * mysql 
 * [http://rubygems.org/ gem] (Gem is like pear for PHP or cpan for Perl.  It lets you install Ruby modules.  Most distro has it packaged.)

Gems requirements:
 * rails --version=2.1.2
 * rake
 * netaddr
 * mysql
 * mongrel (Server for RoR)

Gems can be installed with: `gem install _gemname_`.

Verify gems installation with: `gem list --local`

= Dev  =

Checkout code from source.

svn checkout http://astmob.googlecode.com/svn/trunk/ast ast

Assuming current directory is ast/.  

== Mysql Setup ==

DB setup in RoR application is done via rake.  [http://rake.rubyforge.org/ Rake] is basically ruby make.  RoR has sets of defined tasks that can be performed with rake.  Run `rake --tasks` to see all the tasks it can do.

These two mysql lines should be enough to start dev.  Notice database name differs between dev and prod.
 * `create database ast_development;`
 * `grant all privileges on ast_development.* TO 'root'@'localhost';`

Then load the [https://code.google.com/p/astmob/source/browse/trunk/ast/db/schema.rb schema]

rake db:schema:load

== Start ==

AST uses [http://acts-as-solr.rubyforge.org/ solr] for searching.  It will need be started first before starting the application.  Start it with 
`rake solr:start` 

Given DB is created, you can start AST via 
`script/server`
and something like this should show up
{{{
my_bx:ast malin$ script/server

=> Booting Mongrel (use 'script/server webrick' to force WEBrick)
=> Rails 2.1.2 application starting on http://0.0.0.0:3000
=> Call with -d to detach
=> Ctrl-C to shutdown server
** Starting Mongrel listening at 0.0.0.0:3000
** Starting Rails with development environment...
** Rails loaded.
** Loading any Rails specific GemPlugins
** Signals ready.  TERM => stop.  USR2 => restart.  INT => stop (no restart).
** Rails signals registered.  HUP => reload (without restart).  It might not work well.
** Mongrel 1.1.5 available at 0.0.0.0:3000
** Use CTRL-C to stop.
}}}

You see that AST is now listening on http://0.0.0.0:3000, go there in your browser(replace 0.0.0.0 with ip or hostname of the box) and if it works, good job, you have a working AST.

Now, go to UsageGuide to read about how to start using it.

= Production =

Production deployment is different from dev in that they have different settings.  In dev, it's probably OK to use local database.  In production, you might want to use a managed DB where there is periodic backup and some DBA tending it.  And in dev, you want to see change to .rb file reflects right away where in production, for faster execution, change is not reflected until server is restarted. 

You might also want to use a deploy script instead of doing `svn checkout` on your production server.  AST uses [https://github.com/capistrano/capistrano/wiki/Documentation-v2.x capistrano](another ruby gem) to do its production deployment.  See config/deploy.rb for the setup.  The file tells capistrano what hosts to install, what rake tasks to perform for install, update, rollback or uninstall.  

== Mysql setup ==

Follow the same instruction for dev environment to load schema onto database for production.  

Another way to bootstrap production is to play around in dev environment first then take a sql dump from dev db and export it to production db.

== Deploy ==

For first-time deployment, modify config/deploy.rb to match your environment for parameters such as svn repo, installation directory, number of old copies to keep, proxy gateway, and etc.  

Once that's setup, run
`cap deploy`

Run `cap -T` to see what capistrano can do in AST.

Capistrano basically checkout a copy from defined svn repo, tar them up, ssh to host, untar and execute defined tasks such as `rake db:migrate` or restart server.  In case of `cap deploy:cold`, it does `rake db:create`, `rake db:migrate` and then tries to start server.

I run AST under [http://en.wikipedia.org/wiki/Mongrel_(web_server) Mongrel], a single-threaded web server.  There are [http://www.modrails.com/ other server] for rails which is much recent and probably better..  Mongrel configuration is in config/mongrel_cluster.yml.  You will need to update the file with your AST deploy path and user you want mongrel to run as.

You'll notice configuration has servers: 8.  Which means it will start 8 mongrel process start from port 4500 to 4507.  In order to use all these process, we need to place some sort of a load balancer in front of these mongrel process.  We use [http://httpd.apache.org/docs/2.0/mod/mod_proxy.html apache2 mod proxy].  

[https://code.google.com/p/astmob/source/browse/trunk/apache2/ast  Example apache2 site config] is in the source.

You might want to use init.d start AST.  So you can do something like `/etc/init.d/ast restart`.  Source  also has [https://code.google.com/p/astmob/source/browse/trunk/init.d/ast an example].

Quickly recap.   One time setup for production:
 * Modify config/databases.yml
 * Modify config/mongrel_cluster.yml
 * `cap deploy:cold`
 * Modify apache2 site config and place it wherever apache2 site config should be.
 * Modify init.d config and place it in /etc/init.d.  

After that, additional update is done with:
 * `cap deploy`

== OCSInventory ==

AST polls hardware info such as server model, memory, hard disk from [http://www.ocsinventory-ng.org/en/ OCSInventory] database.

Configuration for ocs database credential is in https://code.google.com/p/astmob/source/browse/trunk/ast/config/database.yml under ocs_*.